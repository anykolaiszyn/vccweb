---
layout: page
permalink: /tobacco-shop/
title: In-Stock Tobacco Products
description: Browse our in-stock tobacco products and pre-order premium cigars, pipes, and tobacco from Vice City Cigars.
---

<div class="tobacco-shop-page">
  <div class="shop-subheader">
    <div class="container">
      <div class="shop-info">
        <h1 class="shop-title">In-Stock Tobacco Products</h1>
        <p class="shop-subtitle">Browse what's available now for pre-order and pickup</p>
      </div>
      <div class="cart-indicator">
        ðŸ›’ Cart: <span id="cartCount">0</span> items
      </div>
    </div>
  </div>

  <main id="main-content" class="container">
    <section id="instock-tobacco" class="card">
      <div class="section-header">
        <h2 class="section-title">In-Stock Tobacco Products</h2>
        <p class="section-subtitle">
          Browse what's currently available at our mobile events and in-person pickups.
          Pre-order your favorites and we'll have them ready for you!
        </p>
      </div>

      <div class="compliance-notice">
        <strong>ðŸ”ž 21+ Only</strong>
        <p>
          All orders are manually age-verified and invoiced.
          No credit card payments are processed on this website.
          We'll contact you to arrange payment and pickup/delivery.
        </p>
      </div>

      <div id="productContainer">
        <div class="loading-state">
          Loading available cigars & tobacco...
        </div>
      </div>
    </section>
  </main>
</div>

<script>
    // ===== Configuration =====
    const API_URL = 'https://script.google.com/macros/s/AKfycbxV-V5BHN2a97yb0fPYVjuofjJRUAFPnPu1d73kKwnxkqXTojYEFK3c0B1qAOzKO1Aquw/exec';
    
    // ===== Global State =====
    let cart = [];

    // ===== Helper Functions =====
    
    /**
     * Sanitize category string - take the last segment after '>'
     */
    function sanitizeCategory(rawCategories) {
      if (!rawCategories || rawCategories.trim() === '') return 'Uncategorized';
      const segments = rawCategories.split('>').map(s => s.trim());
      return segments[segments.length - 1] || 'Uncategorized';
    }

    /**
     * Strip HTML tags from description
     */
    function stripHtml(html) {
      if (!html) return '';
      const temp = document.createElement('div');
      temp.innerHTML = html;
      return temp.textContent || temp.innerText || '';
    }

    /**
     * Format price as currency
     */
    function formatPrice(price) {
      const num = Number(price);
      return isNaN(num) ? '$0.00' : `$${num.toFixed(2)}`;
    }

    /**
     * Update cart counter in header
     */
    function updateCartCounter() {
      const cartCount = document.getElementById('cartCount');
      if (cartCount) {
        cartCount.textContent = cart.length;
      }
        const cartCountHeader = document.getElementById('cartCountHeader');
        if (cartCountHeader) {
          cartCountHeader.textContent = cart.length;
        }
    }

    /**
     * Add item to cart
     */
    function addToCart(sku, name, price) {
      const item = {
        sku: sku,
        name: name,
        price: price,
        timestamp: new Date().toISOString()
      };
      
      cart.push(item);
      updateCartCounter();
      
      console.log('Added to cart:', item);
      console.log('Current cart:', cart);
      
      // Show user feedback
      alert(`Added "${name}" to your pre-order cart!\n\nItems in cart: ${cart.length}`);
    }

    /**
     * Render product cards
     */
    function renderProducts(items) {
      const container = document.getElementById('productContainer');
      
      if (!items || items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            No items are currently in stock. Please check back soon or contact Vice City Cigars.
          </div>
        `;
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'product-grid';

      items.forEach(item => {
        const category = sanitizeCategory(item.Categories);
        const description = stripHtml(item.Description);
        const shortDescription = description.length > 150 
          ? description.substring(0, 150) + '...' 
          : description;
        const sku = item.SKU || 'N/A';
        const stock = item.Qty_On_Hand || 0;
        const price = formatPrice(item.Price);

        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <div>
            <h3 class="product-name">${item.Display_Name || 'Unnamed Product'}</h3>
            <span class="product-category">${category}</span>
          </div>
          <p class="product-description">${shortDescription || 'No description available.'}</p>
          <div class="product-meta">
            <span class="product-stock">In stock: ${stock}</span>
            <span class="product-price">${price}</span>
          </div>
          <div class="product-sku">SKU: ${sku}</div>
          <button class="add-to-cart-btn" data-sku="${sku}" data-name="${item.Display_Name}" data-price="${item.Price}">
            Add to Pre-Order
          </button>
        `;

        grid.appendChild(card);
      });

      container.innerHTML = '';
      container.appendChild(grid);

      // Attach event listeners to all Add to Cart buttons
      const buttons = container.querySelectorAll('.add-to-cart-btn');
      buttons.forEach(button => {
        button.addEventListener('click', (e) => {
          const sku = e.target.dataset.sku;
          const name = e.target.dataset.name;
          const price = e.target.dataset.price;
          addToCart(sku, name, price);
        });
      });
    }

    /**
     * Fetch products from API
     */
    async function fetchProducts() {
      try {
        const response = await fetch(`${API_URL}?route=inventory`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.items) {
          renderProducts(data.items);
        } else {
          throw new Error('Invalid API response format');
        }
      } catch (error) {
        console.error('Error fetching products:', error);
        
        const container = document.getElementById('productContainer');
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load products at this time.</p>
            <p style="color: var(--vcc-text-muted); font-size: 0.9rem; margin-top: 1rem;">
              Error: ${error.message}
            </p>
            <p style="margin-top: 2rem;">
              Please contact Vice City Cigars directly at 
              <a href="tel:+15613310491" style="color: var(--vcc-gold);">561-331-0491</a>
            </p>
          </div>
        `;
      }
    }

    // ===== Initialize on Page Load =====
    document.addEventListener('DOMContentLoaded', () => {
      fetchProducts();
    });

    // ===== Expose cart to console for debugging =====
    window.getCart = () => {
      console.table(cart);
      return cart;
    };

    console.log('%cðŸ”¥ Vice City Cigars Tobacco Shop Loaded', 'color: #ffcc66; font-size: 16px; font-weight: bold;');
    console.log('%cTo view cart contents, type: getCart()', 'color: #00ffff;');
  </script>
