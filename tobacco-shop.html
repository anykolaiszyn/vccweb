---
layout: page
permalink: /tobacco-shop/
title: In-Stock Tobacco Products
description: Browse our in-stock tobacco products and pre-order premium cigars, pipes, and tobacco from Vice City Cigars.
---

<style>
/* ===========================================
   TOBACCO SHOP - CLEAN REBUILD
   Modal system completely redesigned
   =========================================== */

/* Shop Context Banner */
.shop-context-banner {
  position: sticky;
  top: 0;
  z-index: 900;
  padding: 0.75rem 1rem;
  text-align: center;
  font-weight: 700;
  font-size: 0.85rem;
  border-bottom: 2px solid;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  font-family: var(--font-ui, 'Exo 2', sans-serif);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.tobacco-banner {
  background: rgba(255, 20, 147, 0.08);
  border-color: rgba(255, 20, 147, 0.3);
  color: #FF1493;
}

/* Shop Subheader */
.shop-subheader {
  background: transparent;
  border-bottom: 1px solid rgba(255, 20, 147, 0.2);
  padding: 2rem 1rem;
  margin-bottom: 2rem;
}

.shop-subheader .container {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.shop-info h1 {
  font-size: 1.8rem;
  margin: 0 0 0.5rem 0;
  color: #00FFFF;
  font-family: 'Pacifico', cursive;
}

.shop-subtitle {
  font-size: 0.9rem;
  color: #c7d2db;
  margin: 0;
  max-width: 600px;
}

.cart-indicator {
  background: rgba(255, 20, 147, 0.15);
  color: #FF1493;
  padding: 0.6rem 1.2rem;
  border-radius: 20px;
  font-weight: 600;
  border: 1px solid rgba(255, 20, 147, 0.4);
  font-size: 1rem;
}

/* Main Content */
#instock-tobacco {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1rem;
}

.section-title {
  font-size: 2rem;
  margin: 0 0 0.75rem;
  color: #00FFFF;
  font-family: 'Pacifico', cursive;
}

.section-sub {
  color: #9fb0bf;
  margin: 0 0 1rem;
  font-size: 0.95rem;
  line-height: 1.6;
}

.notice {
  background: rgba(255, 204, 102, 0.08);
  border: 1px dashed rgba(255, 204, 102, 0.4);
  color: #ffcc66;
  border-radius: 12px;
  padding: 12px 16px;
  margin: 16px 0 24px;
  font-size: 0.9rem;
}

/* Search & Controls */
.search-controls {
  display: flex;
  gap: 12px;
  margin: 16px 0 24px;
  flex-wrap: wrap;
  align-items: center;
}

.search-box {
  flex: 1;
  min-width: 250px;
  position: relative;
}

.search-box input {
  width: 100%;
  padding: 10px 14px 10px 40px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.14);
  background: rgba(10, 10, 46, 0.6);
  color: #e6edf3;
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

.search-box input:focus {
  outline: none;
  border-color: #00FFFF;
  box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.2);
}

.search-box::before {
  content: 'üîç';
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1rem;
}

.sort-select {
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.14);
  background: rgba(10, 10, 46, 0.6);
  color: #e6edf3;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.sort-select:focus {
  outline: none;
  border-color: #ffcc66;
}

/* Filters */
.filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin: 0 0 24px;
}

.chip {
  border: 1px solid rgba(255, 255, 255, 0.14);
  color: #e6edf3;
  background: transparent;
  border-radius: 999px;
  padding: 8px 16px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.chip:hover {
  border-color: #ffcc66;
  transform: translateY(-2px);
}

.chip.active {
  background: #ffcc66;
  color: #0A0A2E;
  border-color: #ffcc66;
  box-shadow: 0 0 10px rgba(255, 204, 102, 0.4);
}

/* Product Grid */
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 24px;
  margin: 2rem 0;
}

.product-card {
  background: rgba(15, 22, 32, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  transition: all 0.3s ease;
  cursor: pointer;
}

.product-card:hover {
  border-color: #FF1493;
  box-shadow: 0 0 20px rgba(255, 20, 147, 0.3);
  transform: translateY(-4px);
}

.product-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
  background: rgba(10, 10, 46, 0.6);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.product-content {
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  flex-grow: 1;
}

.product-name {
  font-size: 1.1rem;
  margin: 0;
  color: #ffffff;
  font-weight: 600;
}

.product-category {
  color: #9fb0bf;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.product-description {
  color: #c7d2db;
  font-size: 0.9rem;
  line-height: 1.5;
  flex-grow: 1;
  max-height: 80px;
  overflow: hidden;
}

.product-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.95rem;
  padding-top: 8px;
  border-top: 1px solid rgba(255, 255, 255, 0.08);
}

.product-stock {
  color: #00FFFF;
  font-weight: 600;
}

.product-price {
  color: #ffcc66;
  font-size: 1.2rem;
  font-weight: 700;
}

.product-sku {
  font-size: 0.8rem;
  color: #9fb0bf;
}

.add-to-cart-btn {
  background: #ffcc66;
  color: #0A0A2E;
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-size: 0.9rem;
}

.add-to-cart-btn:hover {
  background: #e6b95a;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 204, 102, 0.4);
}

/* MODAL SYSTEM - COMPLETELY REBUILT */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10000;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.modal-overlay.show {
  display: block;
}

.modal-container {
  min-height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-dialog {
  background: #0f1620;
  border: 2px solid #FF1493;
  border-radius: 12px;
  width: 100%;
  max-width: 500px;
  position: relative;
  box-shadow: 0 10px 50px rgba(255, 20, 147, 0.5);
}

.modal-header {
  position: relative;
  border-bottom: 1px solid rgba(255, 20, 147, 0.3);
}

.modal-close {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(255, 20, 147, 0.2);
  border: 1px solid #FF1493;
  color: #FF1493;
  font-size: 1.5rem;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  z-index: 10;
  line-height: 1;
}

.modal-close:hover {
  background: #FF1493;
  color: #0A0A2E;
  transform: rotate(90deg);
}

.modal-image-wrapper {
  width: 100%;
  height: 250px;
  overflow: hidden;
  background: rgba(10, 10, 46, 0.6);
}

.modal-product-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.modal-body {
  padding: 20px;
}

.modal-title {
  font-size: 1.4rem;
  color: #00FFFF;
  margin: 0 0 8px;
  font-family: 'Pacifico', cursive;
  padding-right: 40px;
}

.modal-category {
  color: #ffcc66;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 16px;
  display: block;
}

.modal-description {
  color: #c7d2db;
  line-height: 1.6;
  margin: 16px 0;
  font-size: 0.95rem;
}

.modal-meta {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin: 16px 0;
  padding: 16px;
  background: rgba(255, 20, 147, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(255, 20, 147, 0.3);
}

.meta-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.meta-label {
  color: #9fb0bf;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.meta-value {
  color: #e6edf3;
  font-size: 1.1rem;
  font-weight: 600;
}

.meta-value.price {
  color: #ffcc66;
  font-size: 1.4rem;
}

.meta-value.stock {
  color: #00FFFF;
}

.modal-footer {
  padding: 0 20px 20px;
}

.modal-add-btn {
  width: 100%;
  background: #ffcc66;
  color: #0A0A2E;
  border: none;
  border-radius: 8px;
  padding: 14px 24px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-size: 1rem;
}

.modal-add-btn:hover {
  background: #e6b95a;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 204, 102, 0.4);
}

/* Cart Summary */
.cart-summary {
  margin-top: 32px;
}

.empty {
  color: #9fb0bf;
  font-size: 0.95rem;
  text-align: center;
  padding: 32px;
}

.cart-list {
  background: rgba(15, 22, 32, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}

.cart-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px dashed rgba(255, 255, 255, 0.08);
  color: #e6edf3;
}

.cart-row:last-child {
  border-bottom: none;
}

.checkout-btn {
  width: 100%;
  background: #FF1493;
  color: #ffffff;
  border: 2px solid #00FFFF;
  border-radius: 8px;
  padding: 14px 24px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-size: 1rem;
  box-shadow: 0 0 15px rgba(255, 20, 147, 0.3);
}

.checkout-btn:hover {
  box-shadow: 0 0 25px rgba(255, 20, 147, 0.6);
  transform: translateY(-2px);
}

/* Checkout Form */
.checkout {
  margin-top: 32px;
  background: rgba(15, 22, 32, 0.8);
  border: 2px solid #FF1493;
  border-radius: 12px;
  padding: 24px;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}

.checkout label {
  display: block;
  font-size: 0.85rem;
  color: #9fb0bf;
  margin-bottom: 6px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.checkout input,
.checkout textarea,
.checkout select {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.14);
  background: rgba(10, 10, 46, 0.6);
  color: #e6edf3;
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

.checkout input:focus,
.checkout textarea:focus,
.checkout select:focus {
  outline: none;
  border-color: #00FFFF;
  box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.2);
}

.checkout textarea {
  min-height: 80px;
  resize: vertical;
  font-family: inherit;
}

.btn-primary {
  width: 100%;
  background: #ffcc66;
  color: #0A0A2E;
  border: none;
  border-radius: 8px;
  padding: 14px 24px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-size: 1rem;
  margin-top: 16px;
}

.btn-primary:hover {
  background: #e6b95a;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 204, 102, 0.4);
}

.error {
  background: rgba(255, 107, 107, 0.12);
  border: 1px solid rgba(255, 107, 107, 0.35);
  color: #ffc7c7;
  border-radius: 8px;
  padding: 12px 16px;
  margin-top: 12px;
}

.success {
  background: rgba(57, 215, 200, 0.12);
  border: 1px solid rgba(57, 215, 200, 0.35);
  color: #c9fffa;
  border-radius: 8px;
  padding: 12px 16px;
  margin-top: 12px;
}

/* Loading State */
#loading {
  text-align: center;
  padding: 48px;
  color: #9fb0bf;
}

/* Floating Cart Button */
.floating-cart-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9000;
  background: linear-gradient(135deg, rgba(255, 20, 147, 0.95), rgba(0, 255, 255, 0.2));
  border: 2px solid #00FFFF;
  border-radius: 50px;
  padding: 12px 16px;
  cursor: pointer;
  box-shadow: 0 8px 32px rgba(0, 255, 255, 0.3);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  animation: floatIn 0.4s ease;
}

.floating-cart-btn.hidden {
  display: none;
}

.floating-cart-btn:hover {
  transform: scale(1.08);
  box-shadow: 0 12px 40px rgba(0, 255, 255, 0.5);
}

.floating-cart-content {
  display: flex;
  align-items: center;
  gap: 12px;
  color: #0A0A2E;
  font-weight: 700;
}

.floating-cart-icon {
  font-size: 1.4rem;
}

.floating-cart-total {
  font-size: 1rem;
  color: #0A0A2E;
  font-weight: 700;
}

@keyframes floatIn {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.8);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

/* Toast Notification */
.toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 255, 255, 0.95);
  color: #0A0A2E;
  padding: 14px 24px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.95rem;
  z-index: 9999;
  box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
  animation: slideUp 0.3s ease;
  max-width: 90%;
  text-align: center;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }

  .shop-subheader .container {
    flex-direction: column;
    align-items: flex-start;
  }

  .product-grid {
    grid-template-columns: 1fr;
  }

  .modal-container {
    padding: 10px;
  }

  .modal-dialog {
    max-width: 100%;
  }

  .modal-image-wrapper {
    height: 180px;
  }

  .modal-body {
    padding: 16px;
  }

  .modal-title {
    font-size: 1.2rem;
  }

  .modal-meta {
    grid-template-columns: 1fr;
  }

  .floating-cart-btn {
    bottom: 16px;
    right: 16px;
    padding: 10px 14px;
  }
}
</style>

<div class="shop-context-banner tobacco-banner">
  üîû <strong>TOBACCO SHOP</strong> - Age-Restricted Products Only - Pre-Order System
</div>

<div class="shop-subheader">
  <div class="container">
    <div class="shop-info">
      <h1>Premium Tobacco Products</h1>
      <p class="shop-subtitle">Available for pickup and shipping nationwide where allowed by law. Payment invoiced after age verification.</p>
    </div>
    <div class="cart-indicator">üõí Cart: <span id="cart-count">0</span></div>
  </div>
</div>

<section id="instock-tobacco">
  <h2 class="section-title">Shop Premium Tobacco</h2>
  <p class="section-sub">Browse our selection of premium cigars and tobacco. Orders require age verification. We ship nationwide where allowed by law.</p>
  <div class="notice">üîû 21+ only. All orders require age verification. Payment by invoice after verification. Adult signature required at delivery.</div>

  <!-- Search & Sort -->
  <div class="search-controls">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Search products...">
    </div>
    <select id="sort-select" class="sort-select">
      <option value="name">Sort by Name</option>
      <option value="price-low">Price: Low to High</option>
      <option value="price-high">Price: High to Low</option>
      <option value="stock">Stock Level</option>
    </select>
  </div>

  <!-- Filters -->
  <div class="filters" id="filters-container">
    <button class="chip active" data-filter="all">All Products</button>
  </div>

  <!-- Grid -->
  <div id="loading">Loading products‚Ä¶</div>
  <div id="product-grid" class="product-grid"></div>

  <!-- Cart -->
  <div class="cart-summary" id="cart-summary"></div>

  <!-- Checkout -->
  <div class="checkout" id="checkout-panel" hidden>
    <h3 class="section-title">Checkout & ID Verification</h3>
    <p class="section-sub">Provide your details and upload photo ID for age verification.</p>

    <div id="error-banner" class="error" hidden></div>
    <div id="success-banner" class="success" hidden></div>

    <div class="form-row">
      <div>
        <label for="fullName">Full name *</label>
        <input id="fullName" type="text" required>
      </div>
      <div>
        <label for="email">Email *</label>
        <input id="email" type="email" required>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label for="phone">Phone</label>
        <input id="phone" type="tel">
      </div>
      <div>
        <label for="dob">Date of birth * (21+)</label>
        <input id="dob" type="date" required max="2004-12-04">
      </div>
    </div>

    <div>
      <label for="address">Shipping address</label>
      <textarea id="address"></textarea>
    </div>

    <div class="form-row">
      <div>
        <label for="payment">Payment preference</label>
        <select id="payment">
          <option>Bank Invoice (ACH)</option>
          <option>Bitcoin</option>
          <option>Other</option>
        </select>
      </div>
      <div>
        <label for="idfile">ID upload * (max 5MB)</label>
        <input id="idfile" type="file" accept="image/*,application/pdf" required>
      </div>
    </div>

    <div>
      <label for="notes">Notes</label>
      <textarea id="notes"></textarea>
    </div>

    <button id="submit-btn" class="btn-primary">Submit Order</button>
  </div>
</section>

<!-- Product Modal -->
<div id="product-modal" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-dialog">
      <div class="modal-header">
        <button class="modal-close" aria-label="Close">&times;</button>
        <div class="modal-image-wrapper">
          <img id="modal-image" class="modal-product-image" alt="Product">
        </div>
      </div>
      <div class="modal-body">
        <h3 id="modal-name" class="modal-title"></h3>
        <span id="modal-category" class="modal-category"></span>
        <div id="modal-description" class="modal-description"></div>
        <div class="modal-meta">
          <div class="meta-item">
            <span class="meta-label">Price</span>
            <span id="modal-price" class="meta-value price"></span>
          </div>
          <div class="meta-item">
            <span class="meta-label">In Stock</span>
            <span id="modal-stock" class="meta-value stock"></span>
          </div>
          <div class="meta-item">
            <span class="meta-label">SKU</span>
            <span id="modal-sku" class="meta-value"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modal-add-btn" class="modal-add-btn">Add to Cart</button>
      </div>
    </div>
  </div>
</div>

<!-- Floating Cart -->
<div id="floating-cart" class="floating-cart-btn hidden">
  <div class="floating-cart-content">
    <span class="floating-cart-icon">üõí</span>
    <span class="floating-cart-total" id="floating-total">$0.00</span>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxV-V5BHN2a97yb0fPYVjuofjJRUAFPnPu1d73kKwnxkqXTojYEFK3c0B1qAOzKO1Aquw/exec';

let catalog = [];
let cart = [];
let selectedProduct = null;

// Helpers
function stripHtml(html) {
  const d = document.createElement('div');
  d.innerHTML = html || '';
  return d.textContent || '';
}

function sanitize(text) {
  const d = document.createElement('div');
  d.textContent = text || '';
  return d.innerHTML;
}

function formatPrice(p) {
  const n = Number(p);
  return isNaN(n) ? '$0.00' : `$${n.toFixed(2)}`;
}

function getCategory(item) {
  if (item.Category_Level_2) return item.Category_Level_2;
  if (item.Lowest_Category) return item.Lowest_Category;
  if (item.Categories) {
    const parts = item.Categories.split('>').map(s => s.trim());
    return parts[parts.length > 1 && parts[0].includes('RTPD') ? 1 : 0] || 'Uncategorized';
  }
  return 'Uncategorized';
}

// Cart
function saveCart() {
  localStorage.setItem('vcc-cart', JSON.stringify(cart));
  localStorage.setItem('vcc-cart-time', Date.now());
}

function loadCart() {
  const saved = localStorage.getItem('vcc-cart');
  const time = localStorage.getItem('vcc-cart-time');
  if (saved && time && (Date.now() - parseInt(time) < 86400000)) {
    cart = JSON.parse(saved);
    updateCart();
  }
}

function updateCart() {
  document.getElementById('cart-count').textContent = cart.length;
  const total = cart.reduce((sum, item) => sum + (item.price || 0) * (item.qty || 1), 0);
  document.getElementById('floating-total').textContent = formatPrice(total);
  document.getElementById('floating-cart').classList.toggle('hidden', cart.length === 0);
  renderCart();
}

function addToCart(item) {
  const existing = cart.find(c => c.sku === item.SKU);
  if (existing) {
    existing.qty = (existing.qty || 1) + 1;
  } else {
    cart.push({ sku: item.SKU, name: item.Display_Name, price: Number(item.Price) || 0, qty: 1 });
  }
  saveCart();
  updateCart();
  showToast(`${item.Display_Name} added to cart!`);
}

function showToast(msg) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = msg;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.remove(), 2500);
}

function renderCart() {
  const wrap = document.getElementById('cart-summary');
  wrap.innerHTML = '';
  
  if (cart.length === 0) {
    wrap.innerHTML = '<div class="empty">Your cart is empty.</div>';
    document.getElementById('checkout-panel').hidden = true;
    return;
  }
  
  const list = document.createElement('div');
  list.className = 'cart-list';
  
  const header = document.createElement('div');
  header.style.cssText = 'font-weight: 700; color: #00FFFF; margin-bottom: 12px;';
  const totalItems = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
  header.textContent = `Your Cart (${totalItems} item${totalItems !== 1 ? 's' : ''})`;
  list.appendChild(header);
  
  cart.forEach((item, i) => {
    const row = document.createElement('div');
    row.className = 'cart-row';
    row.innerHTML = `
      <div>
        <div style="color: #e6edf3; font-weight: 600;">${sanitize(item.name)}</div>
        <div style="color: #9fb0bf; font-size: 0.85rem;">Qty: ${item.qty} √ó ${formatPrice(item.price)}</div>
      </div>
      <div style="display: flex; gap: 12px; align-items: center;">
        <span style="color: #ffcc66; font-weight: 700;">${formatPrice(item.price * item.qty)}</span>
        <button class="remove-btn" data-index="${i}" style="background: rgba(255, 107, 107, 0.2); border: 1px solid #ff6b6b; color: #ff6b6b; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Remove</button>
      </div>
    `;
    list.appendChild(row);
  });
  
  const subtotal = cart.reduce((sum, item) => sum + (item.price || 0) * (item.qty || 1), 0);
  const totalRow = document.createElement('div');
  totalRow.style.cssText = 'display: flex; justify-content: space-between; padding: 12px 0; margin-top: 12px; border-top: 2px solid #FF1493; color: #00FFFF; font-size: 1.2rem; font-weight: 700;';
  totalRow.innerHTML = `<span>Total:</span><span>${formatPrice(subtotal)}</span>`;
  list.appendChild(totalRow);
  
  wrap.appendChild(list);
  
  const btn = document.createElement('button');
  btn.className = 'checkout-btn';
  btn.textContent = 'Proceed to Checkout';
  btn.onclick = () => {
    document.getElementById('checkout-panel').hidden = false;
    document.getElementById('checkout-panel').scrollIntoView({ behavior: 'smooth' });
  };
  wrap.appendChild(btn);
  
  // Remove buttons
  setTimeout(() => {
    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.onclick = () => {
        cart.splice(parseInt(btn.dataset.index), 1);
        saveCart();
        updateCart();
      };
    });
  }, 0);
}

// Modal
function openModal(item) {
  selectedProduct = item;
  
  const imgUrl = item.Drive_Image_URL || item.Square_Image_URL || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%231a1a3e" width="400" height="300"/%3E%3Ctext fill="%2300ffff" font-family="Arial" font-size="24" x="50%25" y="50%25" text-anchor="middle"%3ENo Image%3C/text%3E%3C/svg%3E';
  
  document.getElementById('modal-image').src = imgUrl;
  document.getElementById('modal-name').textContent = item.Display_Name || 'Product';
  document.getElementById('modal-category').textContent = getCategory(item);
  document.getElementById('modal-description').textContent = stripHtml(item.Description || 'No description.');
  document.getElementById('modal-price').textContent = formatPrice(item.Price);
  document.getElementById('modal-stock').textContent = item.Qty_On_Hand || 0;
  document.getElementById('modal-sku').textContent = item.SKU || 'N/A';
  
  document.getElementById('product-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('product-modal').classList.remove('show');
  document.body.style.overflow = '';
  selectedProduct = null;
}

// Catalog
async function loadCatalog() {
  try {
    const res = await fetch(`${API_URL}?route=inventory`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    catalog = data.items || [];
    buildFilters();
    renderGrid(catalog);
  } catch (err) {
    document.getElementById('loading').textContent = `Error loading products: ${err.message}`;
  }
}

function renderGrid(items) {
  const grid = document.getElementById('product-grid');
  const loading = document.getElementById('loading');
  loading.style.display = 'none';
  grid.innerHTML = '';
  
  if (!items.length) {
    loading.style.display = 'block';
    loading.textContent = 'No products found.';
    return;
  }
  
  items.forEach(item => {
    const desc = stripHtml(item.Description || '');
    const short = desc.length > 120 ? desc.slice(0, 120) + '‚Ä¶' : desc;
    const imgUrl = item.Drive_Image_URL || item.Square_Image_URL || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%231a1a3e" width="400" height="300"/%3E%3Ctext fill="%2300ffff" font-family="Arial" font-size="18" x="50%25" y="50%25" text-anchor="middle"%3ENo Image%3C/text%3E%3C/svg%3E';
    
    const card = document.createElement('div');
    card.className = 'product-card';
    card.innerHTML = `
      <img src="${imgUrl}" alt="${sanitize(item.Display_Name)}" class="product-image" loading="lazy">
      <div class="product-content">
        <div>
          <h3 class="product-name">${sanitize(item.Display_Name || 'Product')}</h3>
          <span class="product-category">${sanitize(getCategory(item))}</span>
        </div>
        <p class="product-description">${sanitize(short)}</p>
        <div class="product-meta">
          <span class="product-stock">Stock: ${item.Qty_On_Hand || 0}</span>
          <span class="product-price">${formatPrice(item.Price)}</span>
        </div>
        <div class="product-sku">SKU: ${sanitize(item.SKU || 'N/A')}</div>
        <button class="add-to-cart-btn">Add to Cart</button>
      </div>
    `;
    
    card.onclick = (e) => {
      if (!e.target.closest('.add-to-cart-btn')) openModal(item);
    };
    
    card.querySelector('.add-to-cart-btn').onclick = (e) => {
      e.stopPropagation();
      addToCart(item);
    };
    
    grid.appendChild(card);
  });
}

function buildFilters() {
  const categories = new Set();
  catalog.forEach(item => {
    const cat = getCategory(item);
    if (cat && cat !== 'Uncategorized') categories.add(cat);
  });
  
  const container = document.getElementById('filters-container');
  container.innerHTML = '<button class="chip active" data-filter="all">All Products</button>';
  
  Array.from(categories).sort().forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.dataset.filter = cat;
    btn.textContent = cat;
    btn.onclick = () => {
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      renderGrid(catalog.filter(item => getCategory(item) === cat));
    };
    container.appendChild(btn);
  });
  
  container.querySelector('[data-filter="all"]').onclick = () => {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    container.querySelector('[data-filter="all"]').classList.add('active');
    renderGrid(catalog);
  };
}

// Search
document.getElementById('search-input').addEventListener('input', (e) => {
  const query = e.target.value.toLowerCase();
  const filtered = query ? catalog.filter(item => 
    (item.Display_Name || '').toLowerCase().includes(query) ||
    (item.SKU || '').toLowerCase().includes(query) ||
    stripHtml(item.Description || '').toLowerCase().includes(query)
  ) : catalog;
  renderGrid(filtered);
});

// Sort
document.getElementById('sort-select').addEventListener('change', (e) => {
  const sorted = [...catalog];
  switch (e.target.value) {
    case 'price-low': sorted.sort((a, b) => (a.Price || 0) - (b.Price || 0)); break;
    case 'price-high': sorted.sort((a, b) => (b.Price || 0) - (a.Price || 0)); break;
    case 'stock': sorted.sort((a, b) => (b.Qty_On_Hand || 0) - (a.Qty_On_Hand || 0)); break;
    default: sorted.sort((a, b) => (a.Display_Name || '').localeCompare(b.Display_Name || ''));
  }
  renderGrid(sorted);
});

// Modal controls
document.querySelector('.modal-close').onclick = closeModal;
document.getElementById('product-modal').onclick = (e) => {
  if (e.target.id === 'product-modal') closeModal();
};
document.getElementById('modal-add-btn').onclick = () => {
  if (selectedProduct) {
    addToCart(selectedProduct);
    closeModal();
  }
};

// Checkout
document.getElementById('submit-btn').onclick = async () => {
  const err = document.getElementById('error-banner');
  const ok = document.getElementById('success-banner');
  err.hidden = ok.hidden = true;
  
  try {
    const name = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    const dob = document.getElementById('dob').value;
    const file = document.getElementById('idfile').files[0];
    
    if (!name || !email || !dob) throw new Error('Please fill required fields.');
    if (!cart.length) throw new Error('Cart is empty.');
    if (!file) throw new Error('ID upload required.');
    
    const age = Math.floor((new Date() - new Date(dob)) / 31557600000);
    if (age < 21) throw new Error('Must be 21+.');
    
    ok.hidden = false;
    ok.textContent = 'Order submitted! Check your email for invoice.';
    cart = [];
    saveCart();
    updateCart();
    document.getElementById('checkout-panel').hidden = true;
  } catch (e) {
    err.hidden = false;
    err.textContent = e.message;
  }
};

// Init
document.addEventListener('DOMContentLoaded', () => {
  loadCatalog();
  loadCart();
  document.getElementById('floating-cart').onclick = () => {
    document.getElementById('cart-summary').scrollIntoView({ behavior: 'smooth' });
  };
});

// Escape to close modal
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('product-modal').classList.contains('show')) {
    closeModal();
  }
});
</script>
